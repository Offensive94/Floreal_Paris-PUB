{% extends "base/base_template.html" %}
{% load static %}
{% block title %}Корзина{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'products/cart/main_cart.css' %}">
{% endblock %}

{% block content %}

<div id="cart-container">
    <h2 class="text-center">Ваша Корзина</h2>

    <div id="cart-items">
        {% for item in cart.items.all %}
            <div class="cart-item" id="item-{{ item.product.id }}">
                <a href="{% url 'product_detail' item.product.id %}" class="cart-link">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}"
                             class="cart-img"
                             alt="{{ item.product.title }}">
                    {% else %}
                        <div class="cart-img placeholder">No Image</div>
                    {% endif %}

                    <div class="cart-details">
                        <p class="cart-title">{{ item.product.title }}</p>
                    </div>
                </a>

                <!-- Управление количеством -->
                <div class="qty-controls">
                    <button class="qty-btn"
                            onclick="updateItem({{ item.product.id }}, 'decrement')"
                            {% if item.quantity <= 1 %}disabled{% endif %}>−</button>
                    <span id="qty-{{ item.product.id }}">{{ item.quantity }}</span>
                    <button class="qty-btn"
                            onclick="updateItem({{ item.product.id }}, 'increment')">＋</button>
                </div>

                <!-- Стилизованная кнопка удаления -->
                <button class="remove-btn" onclick="removeItem({{ item.product.id }})">
                    <i class="fa-solid fa-ban"></i>
                </button>
            </div>
        {% empty %}
            <p class="empty-cart">Ваша корзина пуста</p>
        {% endfor %}
    </div>

    {% if cart.total_items %}
        <div id="cart-summary">
            <span id="cart-count">Всего: {{ cart.total_items }}</span>
            <span id="cart-total">{{ cart.total_price }} ₽</span>
        </div>
    {% endif %}

    <div class="cart-actions">
        <button id="clear-cart-btn" class="cart-btn"
                onclick="clearCart()"
                {% if cart.total_items == 0 %}disabled{% endif %}>
            <i class="fa-solid fa-cart-arrow-down"></i>
            Очистить корзину
        </button>
        <a href="{% url 'checkout' %}" class="cart-btn checkout-btn"
           {% if cart.total_items == 0 %}aria-disabled="true"{% endif %}>
            Оформить заказ
        </a>
    </div>
</div>

<script>
function updateItem(pid, action) {
    const itemElement = document.getElementById(`item-${pid}`);
    const qtyBtn = itemElement.querySelector('.qty-controls button');

    fetch("{% url 'update_cart_item' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ product_id: pid, action: action })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) return alert('Ошибка!');

        // Обновляем количество в элементе
        const qtyEl = document.getElementById(`qty-${pid}`);
        if (qtyEl) qtyEl.textContent = data.item_quantity;

        // Обновляем общую информацию
        document.getElementById('cart-count').textContent = `${data.cart_count} ${getNoun(data.cart_count, 'товар', 'товара', 'товаров')}`;
        document.getElementById('cart-total').textContent = `${data.cart_total} ₽`;

        // Обновляем состояние кнопки уменьшения
        const decBtn = itemElement.querySelector('.qty-btn:first-child');
        decBtn.disabled = data.item_quantity <= 1;

        // Если количество стало 0 - удаляем элемент с анимацией
        if (data.item_quantity === 0) {
            itemElement.classList.add('remove-animation');
            setTimeout(() => {
                itemElement.remove();
                updateCartState(data.cart_count);
            }, 500);
        } else {
            updateCartState(data.cart_count);
        }
    });
}

function clearCart() {
    const cartContainer = document.getElementById('cart-items');
    cartContainer.classList.add('cart-clear-animation');

    setTimeout(() => {
        fetch("{% url 'clear_cart' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cartContainer.innerHTML = '<p class="empty-cart">Ваша корзина пуста</p>';
                cartContainer.classList.remove('cart-clear-animation');
                updateCartSummary(0, "0.00");
            } else {
                cartContainer.classList.remove('cart-clear-animation');
                alert(data.error);
            }
        });
    }, 700);
}

function updateCartSummary(count, total) {
    document.getElementById('cart-total').textContent = `${total} ₽`;
    document.getElementById('cart-count').textContent = `${count} ${getNoun(count, 'товар', 'товара', 'товаров')}`;
    updateCartState(count);
}

function updateCartState(count) {
    const clearBtn = document.getElementById('clear-cart-btn');
    const checkoutBtn = document.querySelector('.checkout-btn');

    if (count === 0) {
        clearBtn.disabled = true;
        checkoutBtn.style.pointerEvents = 'none';
        checkoutBtn.style.opacity = '0.6';
    } else {
        clearBtn.disabled = false;
        checkoutBtn.style.pointerEvents = 'auto';
        checkoutBtn.style.opacity = '1';
    }
}

// Вспомогательная функция для склонения слов
function getNoun(number, one, two, five) {
    let n = Math.abs(number);
    n %= 100;
    if (n >= 5 && n <= 20) return five;
    n %= 10;
    if (n === 1) return one;
    if (n >= 2 && n <= 4) return two;
    return five;
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
    const count = parseInt("{{ cart.total_items }}");
    updateCartSummary(count, "{{ cart.total_price }}");

    // Инициализация состояния кнопок уменьшения
    document.querySelectorAll('.cart-item').forEach(item => {
        const qty = parseInt(item.querySelector('.qty-controls span').textContent);
        const decBtn = item.querySelector('.qty-btn:first-child');
        decBtn.disabled = qty <= 1;
    });
});

    function removeItem(pid) {
    const itemElement = document.getElementById(`item-${pid}`);

    fetch("{% url 'remove_cart_item' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ product_id: pid })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            itemElement.classList.add('remove-animation');
            setTimeout(() => {
                itemElement.remove();
                updateCartSummary(data.cart_count, data.cart_total);
            }, 500);
        } else {
            alert("Ошибка при удалении товара.");
        }
    });
}

</script>
{% endblock %}